<% content_for :primary_navigation do %>
  <%= render partial: "shared/navigation/service_support_primary_navigation" %>
<% end %>
<% content_for :page_title do %>
  <%= page_title(t("service_support.dotnet_rerouting_rules.title")) %>
<% end %>
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <h2 class="govuk-heading-l">Rerouting patterns</h2>
    <p class="govuk-body">
      The following patterns are defined for rerouting to the .NET version of the service:
    </p>
    
    <% if @patterns.empty? %>
      <div class="govuk-warning-text">
        <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
        <strong class="govuk-warning-text__text">
          <span class="govuk-warning-text__assistive">Warning</span>
          No patterns found. This is likely due to insufficient Azure permissions. 
        </strong>
      </div>
    <% elsif Rails.env.development? && @patterns.include?("groups/*") %>
      <div class="govuk-inset-text">
        <strong>Development Mode:</strong> Using sample patterns for testing. 
        In production, patterns are fetched from Azure Front Door.
      </div>
    <% end %>
    
    <table class="govuk-table rerouting-patterns">
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th scope="col" class="govuk-table__header">Pattern</th>
          <th scope="col" class="govuk-table__header">Type</th>
          <th scope="col" class="govuk-table__header">Matches</th>
        </tr>
      </thead>
      <tbody class="govuk-table__body">
        <% @patterns.each do |pattern| %>
          <% matching_routes = @routes.select { |route| route.matching_pattern == pattern } %>
          <tr class="govuk-table__row rerouting-pattern">
            <td class="govuk-table__cell">
              <code class="pattern-code"><%= pattern %></code>
            </td>
            <td class="govuk-table__cell">
              <span class="govuk-tag <%= pattern.include?('*') || pattern.include?('?') ? 'govuk-tag--blue' : 'govuk-tag--green' %>">
                <%= pattern.include?('*') || pattern.include?('?') ? 'Wildcard' : 'Exact' %>
              </span>
            </td>
            <td class="govuk-table__cell">
              <span class="govuk-tag govuk-tag--grey">
                <%= matching_routes.count %> route<%= 's' if matching_routes.count != 1 %>
              </span>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <h2 class="govuk-heading-l">Application routes</h2>
    <p class="govuk-body">
      The effect of these patterns on the application's routes is shown:
    </p>
    <table class="govuk-table app-routes">
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          <th scope="col" class="govuk-table__header">Route</th>
          <th scope="col" class="govuk-table__header">Status</th>
          <th scope="col" class="govuk-table__header">Matched Pattern</th>
        </tr>
      </thead>
      <tbody class="govuk-table__body">
        <% @routes.each do |route| %>
          <tr class="govuk-table__row app-route <%= route.match? ? 'rerouting-match' : '' %>">
            <td class="govuk-table__cell">
              <% if route.match? %>
                <%= route.highlighted_route %>
              <% else %>
                <code><%= route.route %></code>
              <% end %>
            </td>
            <td class="govuk-table__cell">
              <% if route.match? %>
                <span class="govuk-tag govuk-tag--red">Rerouted</span>
              <% else %>
                <span class="govuk-tag govuk-tag--grey">Normal</span>
              <% end %>
            </td>
            <td class="govuk-table__cell">
              <% if route.match? %>
                <code class="matched-pattern"><%= route.matching_pattern %></code>
              <% else %>
                <span class="govuk-body-s">â€”</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
