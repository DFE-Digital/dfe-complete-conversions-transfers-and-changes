# Email Inventory

## Overview

This document provides a complete inventory of all automated emails in the DfE Complete Conversions, Transfers and Changes application.

**Total Automated Emails: 4**
- 3 Mailer Classes
- 4 Email Methods
- All emails use GOV.UK Notify with template IDs
- All emails use async delivery (`deliver_later`) except in test specs

## Complete Email Inventory Table

| # | Email (Mailer#method) | Template ID | Trigger/Event | Sync/Async (Queue) | To/CC/BCC Source | Subject (final) | Template Path(s) | Feature Flags/Guards | Caller Locations | Notes |
|---|---|---|---|---|---|---|---|---|---|---|
| 1 | `UserAccountMailer#new_account_added` | `d55de8f1-ce5a-4498-8229-baac7c0ee45f` | User account creation by service support | Async (`default`) | `user.email` | *From GOV.UK Notify template* | N/A (GOV.UK Notify template) | None | `app/controllers/service_support/users_controller.rb:101` | Sent when service support creates new user account |
| 2 | `TeamLeaderMailer#new_conversion_project_created` | `ea4f72e4-f5bb-4b1a-b5f9-a94cc1840353` | Conversion project created/assigned to regional caseworker team | Async (`default`) | `team_leader.email` (all team leaders) | *From GOV.UK Notify template* | N/A (GOV.UK Notify template) | `if team_leader.active` | `app/forms/conversion/create_project_form.rb:31`<br>`app/forms/edit_project_form.rb:40`<br>`app/controllers/all/handover/handovers_controller.rb:83` | Sent to all active team leaders when conversion project assigned to regional caseworker team |
| 3 | `TeamLeaderMailer#new_transfer_project_created` | `b0df8e28-ea23-46c5-9a83-82abc6b29193` | Transfer project created/assigned to regional caseworker team | Async (`default`) | `team_leader.email` (all team leaders) | *From GOV.UK Notify template* | N/A (GOV.UK Notify template) | `if team_leader.active` | `app/forms/transfer/create_project_form.rb:88` | Sent to all active team leaders when transfer project assigned to regional caseworker team |
| 4 | `AssignedToMailer#assigned_notification` | `ec6823ec-0aae-439b-b2f9-c626809b7c61` | Project assigned to specific caseworker | Async (`default`) | `user.email` | *From GOV.UK Notify template* | N/A (GOV.UK Notify template) | `if user.active` | `app/forms/internal_contacts/edit_assigned_user_form.rb:43` | Sent to caseworker when project is assigned to them |

## Detailed Email Analysis

### 1. UserAccountMailer#new_account_added

**Purpose**: Notify new users that their account has been created
**Template ID**: `d55de8f1-ce5a-4498-8229-baac7c0ee45f`
**Personalization Variables**:
- `first_name`: User's first name

**Trigger Flow**:
1. Service support user creates new account via `ServiceSupport::UsersController#create`
2. After successful user creation, `send_new_account_email(user)` is called
3. `UserAccountMailer.new_account_added(user).deliver_later` enqueues email

**Code References**:
- Mailer: `app/mailers/user_account_mailer.rb:2-10`
- Controller: `app/controllers/service_support/users_controller.rb:100-102`
- Test: `spec/mailers/user_account_mailer_spec.rb:3-15`

### 2. TeamLeaderMailer#new_conversion_project_created

**Purpose**: Notify team leaders when a new conversion project is created and assigned to regional caseworker team
**Template ID**: `ea4f72e4-f5bb-4b1a-b5f9-a94cc1840353`
**Personalization Variables**:
- `first_name`: Team leader's first name
- `project_url`: URL to the project (generated by `url_to_project(project)`)

**Trigger Flows**:
1. **Project Creation**: When conversion project created with `assigned_to_regional_caseworker_team: true`
2. **Project Handover**: When project is handed over to regional caseworker team
3. **Manual Handover**: Via handover controller when project assigned to regional team

**Code References**:
- Mailer: `app/mailers/team_leader_mailer.rb:2-11`
- Form triggers: 
  - `app/forms/conversion/create_project_form.rb:29-32`
  - `app/forms/edit_project_form.rb:38-41`
- Controller trigger: `app/controllers/all/handover/handovers_controller.rb:81-84`
- Test: `spec/mailers/team_leader_mailer_spec.rb:4-21`

### 3. TeamLeaderMailer#new_transfer_project_created

**Purpose**: Notify team leaders when a new transfer project is created and assigned to regional caseworker team
**Template ID**: `b0df8e28-ea23-46c5-9a83-82abc6b29193`
**Personalization Variables**:
- `first_name`: Team leader's first name
- `project_url`: URL to the project (generated by `url_to_project(project)`)

**Trigger Flow**:
1. **Project Creation**: When transfer project created with `assigned_to_regional_caseworker_team: true`

**Code References**:
- Mailer: `app/mailers/team_leader_mailer.rb:13-22`
- Form trigger: `app/forms/transfer/create_project_form.rb:86-89`
- Test: `spec/mailers/team_leader_mailer_spec.rb:23-40`

### 4. AssignedToMailer#assigned_notification

**Purpose**: Notify caseworker when a project is assigned to them
**Template ID**: `ec6823ec-0aae-439b-b2f9-c626809b7c61`
**Personalization Variables**:
- `first_name`: Caseworker's first name
- `project_url`: URL to the project (generated by `url_to_project(project)`)

**Trigger Flow**:
1. **Project Assignment**: When project is assigned to a specific caseworker via internal contacts form

**Code References**:
- Mailer: `app/mailers/assigned_to_mailer.rb:2-11`
- Form trigger: `app/forms/internal_contacts/edit_assigned_user_form.rb:42-44`
- Test: `spec/mailers/assigned_to_mailer_spec.rb:3-22`

## Recipient Logic

### Team Leaders
- **Scope**: `User.team_leaders` (`app/models/user.rb:14`)
- **Definition**: `where(manage_team: true).order_by_first_name`
- **Active Check**: `if team_leader.active` (checks `deactivated_at.nil?`)

### Assignable Users
- **Scope**: `User.assignable` (`app/models/user.rb:23`)
- **Definition**: `where(assign_to_project: true)`
- **Active Check**: `if user.active` (checks `deactivated_at.nil?`)

## Delivery Configuration

### Queue Adapter by Environment
- **Production**: `config.active_job.queue_adapter = :sidekiq` (`config/environments/production.rb:103`)
- **Test**: `config.active_job.queue_adapter = :test` (`config/environments/test.rb:60`)
- **Development**: No explicit adapter (defaults to async or inline)

### GOV.UK Notify Configuration
- **Delivery Method**: `:notify` in all environments
- **API Key**: `ENV["GOV_NOTIFY_API_KEY"]` (required per `config/initializers/dontenv.rb:6`)
- **Base Mailer**: `ApplicationMailer < Mail::Notify::Mailer` (`app/mailers/application_mailer.rb:1`)

## Guards and Conditions

All emails have conditional guards that prevent sending:

1. **User Active Status**: All emails check `if user.active` or `if team_leader.active`
2. **Team Assignment**: Team leader emails only sent when `assigned_to_regional_caseworker_team == true`
3. **User Scope**: Team leader emails sent to all users in `User.team_leaders` scope
4. **Assignment Capability**: Assigned notification only sent to users in `User.assignable` scope

## Template Verification Status

**Note**: Template IDs have been identified from code but need verification against GOV.UK Notify dashboard at:
https://www.notifications.service.gov.uk/services/32d75f94-b459-4e65-b753-3f9d55c8c9b7

See [RELIABILITY_CHECKLIST.md](./RELIABILITY_CHECKLIST.md) for template verification details.
